{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto py-10" id="tool-container">
    
    <!-- 1. THE ENGINEERING ANIMATION OVERLAY (Hidden by default) -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/95 z-50 hidden flex-col items-center justify-center backdrop-blur-md transition-opacity duration-500">
        
        <!-- The Pen & Paper Animation -->
        <div class="relative w-24 h-24 mb-8">
            <!-- The Paper -->
            <div class="absolute inset-0 bg-gray-200 rounded-lg shadow-[0_0_30px_rgba(212,175,55,0.2)] transform rotate-3 border border-gray-400 overflow-hidden flex flex-col justify-center p-4 gap-3">
                <div class="h-1 bg-gray-400 rounded w-3/4 animate-pulse"></div>
                <div class="h-1 bg-gray-400 rounded w-full animate-pulse delay-75"></div>
                <div class="h-1 bg-gray-400 rounded w-5/6 animate-pulse delay-150"></div>
                <div class="h-1 bg-gray-400 rounded w-4/5 animate-pulse delay-200"></div>
            </div>
            <!-- The Pen -->
            <div class="absolute -right-6 -bottom-6 text-5xl filter drop-shadow-lg animate-writing">
                ‚úçÔ∏è
            </div>
        </div>

        <h2 class="text-3xl font-serif text-white mb-3 tracking-[0.2em]">ENGINEERING</h2>
        
        <!-- Cycling Status Text -->
        <div id="loading-text" class="text-gold font-mono text-xs uppercase tracking-[0.3em] border border-gold/30 px-6 py-2 rounded-full bg-gold/5">
            Initializing Deep Search...
        </div>
    </div>

    <!-- 2. HEADER -->
    <div class="text-center mb-12" data-aos="fade-down">
        <h1 class="text-4xl md:text-5xl font-serif text-white">CodyMailz<span class="text-gold"> AI Tool</span></h1>
        <p class="text-gray-500 text-xs uppercase tracking-widest mt-3">Deep Research & R.E.P.L.Y. Framework Engine</p>
    </div>

    <!-- 3. INPUT FORM -->
    <div class="glass-panel p-8 md:p-10 rounded-2xl relative z-10 max-w-5xl mx-auto border-t-4 border-gold shadow-2xl" data-aos="fade-up">
        <form action="/generate" method="post" class="space-y-8" onsubmit="startLoading()">
            
            <!-- Context Inputs -->
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <label class="block text-xs uppercase tracking-widest text-gray-500 mb-2 font-bold">Target Profile</label>
                    <input type="text" name="target" value="{{ target }}" placeholder="e.g. Logistics Manager at DHL" required
                           class="w-full bg-black/50 border border-gray-700 text-white p-4 rounded focus:border-gold outline-none transition-colors placeholder-gray-600">
                </div>
                <div>
                    <label class="block text-xs uppercase tracking-widest text-gray-500 mb-2 font-bold">Your Offer</label>
                    <input type="text" name="service" value="{{ service }}" placeholder="e.g. AI Automation for Logistics" required
                           class="w-full bg-black/50 border border-gray-700 text-white p-4 rounded focus:border-gold outline-none transition-colors placeholder-gray-600">
                </div>
            </div>
            
            <div>
                <label class="block text-xs uppercase tracking-widest text-gray-500 mb-2 font-bold">Context / Pain Point</label>
                <textarea name="source" rows="2" placeholder="Paste a link, a specific problem, or recent news..." required
                          class="w-full bg-black/50 border border-gray-700 text-white p-4 rounded focus:border-gold outline-none transition-colors placeholder-gray-600">{{ source }}</textarea>
            </div>

            <!-- CONTROLS DASHBOARD -->
            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800 space-y-8">
                
                <!-- Row 1: Length & Creativity -->
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Length Selector -->
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-gold mb-3 font-bold">Protocol Length</label>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="cursor-pointer group">
                                <input type="radio" name="length" value="Short (Sniper)" class="peer sr-only" {% if length == 'Short (Sniper)' or not length %}checked{% endif %}>
                                <div class="p-3 border border-gray-700 rounded text-center text-gray-400 peer-checked:border-gold peer-checked:text-gold peer-checked:bg-gold/10 transition text-sm group-hover:border-gray-500">
                                    ‚ö° Sniper (Short)
                                </div>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="length" value="Detailed (Consultant)" class="peer sr-only" {% if length == 'Detailed (Consultant)' %}checked{% endif %}>
                                <div class="p-3 border border-gray-700 rounded text-center text-gray-400 peer-checked:border-gold peer-checked:text-gold peer-checked:bg-gold/10 transition text-sm group-hover:border-gray-500">
                                    üìú Consultant (Long)
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Creativity Slider -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="block text-xs uppercase tracking-widest text-gold font-bold">AI Temperature</label>
                            <span id="temp-val" class="text-xs text-white font-mono bg-black px-2 rounded border border-gray-700">0.7 (Balanced)</span>
                        </div>
                        <input type="range" name="creativity" min="0.1" max="1.0" step="0.1" value="{{ creativity or 0.7 }}" 
                               class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-gold hover:bg-gray-600 transition"
                               oninput="updateTemp(this.value)">
                        <div class="flex justify-between text-[10px] text-gray-500 mt-2 uppercase tracking-widest">
                            <span>Safe / Strict</span>
                            <span>Bold / Creative</span>
                        </div>
                    </div>
                </div>

                <!-- Row 2: Psychology Checkboxes -->
                <div>
                    <label class="block text-xs uppercase tracking-widest text-gold mb-4 font-bold flex items-center gap-2">
                        <span>üß† Psychology Triggers</span>
                        <span class="text-[10px] text-gray-500 font-normal normal-case">(Select at least one)</span>
                    </label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <label class="flex items-center space-x-3 cursor-pointer group p-2 hover:bg-white/5 rounded transition">
                            <input type="checkbox" name="styles" value="Urgency/Loss Aversion" class="form-checkbox h-4 w-4 text-gold rounded border-gray-600 bg-black focus:ring-0 focus:ring-offset-0">
                            <span class="text-gray-400 text-sm group-hover:text-white transition">Loss Aversion</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer group p-2 hover:bg-white/5 rounded transition">
                            <input type="checkbox" name="styles" value="Data-Backed/Statistical" class="form-checkbox h-4 w-4 text-gold rounded border-gray-600 bg-black focus:ring-0 focus:ring-offset-0">
                            <span class="text-gray-400 text-sm group-hover:text-white transition">Data Insight</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer group p-2 hover:bg-white/5 rounded transition">
                            <input type="checkbox" name="styles" value="Pain Magnification" class="form-checkbox h-4 w-4 text-gold rounded border-gray-600 bg-black focus:ring-0 focus:ring-offset-0">
                            <span class="text-gray-400 text-sm group-hover:text-white transition">Pain Focus</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer group p-2 hover:bg-white/5 rounded transition">
                            <input type="checkbox" name="styles" value="Relatable/Peer-to-Peer" class="form-checkbox h-4 w-4 text-gold rounded border-gray-600 bg-black focus:ring-0 focus:ring-offset-0">
                            <span class="text-gray-400 text-sm group-hover:text-white transition">Peer Tone</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- SUBMIT BUTTON -->
            <button type="submit" class="w-full group bg-gold text-black font-bold uppercase tracking-widest py-5 rounded hover:bg-white transition duration-500 shadow-[0_0_30px_rgba(212,175,55,0.2)] flex justify-center items-center gap-4 text-sm relative overflow-hidden">
                <span class="relative z-10">Initiate Deep Search Protocol</span>
                <span class="text-2xl relative z-10 group-hover:translate-x-2 transition-transform">üöÄ</span>
                <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-500"></div>
            </button>
        </form>
    </div>

    <!-- 4. RESULTS SECTION -->
    {% if result %}
    <div id="result-section" class="mt-20 pt-10 border-t border-gray-800 animate-fade-in-up">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
            <div>
                <h3 class="text-white font-serif text-3xl">Output Protocols</h3>
                <p class="text-gray-500 text-xs mt-1">Generated based on Live Research</p>
            </div>
            
            <!-- Tags Display -->
            <div class="flex gap-2 flex-wrap justify-center">
                {% for style in selected_styles %}
                <span class="text-[10px] uppercase tracking-widest border border-gold/30 text-gold px-3 py-1 rounded bg-gold/5">{{ style }}</span>
                {% endfor %}
            </div>
        </div>
        
        <div class="grid md:grid-cols-2 gap-10">
            
            <!-- OPTION A -->
            <div class="glass-panel p-8 rounded-xl border border-gray-700 hover:border-gold transition duration-500 group relative flex flex-col">
                <div class="absolute -top-3 left-6 bg-black px-3 border border-gold/50 text-gold text-xs uppercase tracking-widest font-bold">
                    {{ result.style_a }}
                </div>
                
                <div class="mb-6 mt-4">
                    <span class="text-gray-500 text-[10px] uppercase tracking-widest font-bold">Subject Line</span>
                    <p class="text-white font-mono text-sm border-b border-gray-800 pb-2 mt-2 select-all">{{ result.subject_a }}</p>
                </div>
                
                <div class="bg-gray-900/50 p-4 rounded border border-gray-800 mb-8 flex-grow">
                    <pre id="email-a" class="text-gray-300 whitespace-pre-wrap font-sans text-sm leading-relaxed">{{ result.body_a }}</pre>
                </div>
                
                <button onclick="copyToClip('email-a')" class="w-full bg-gray-800 text-gray-400 text-xs uppercase tracking-widest py-3 rounded hover:bg-gold hover:text-black transition font-bold border border-gray-700 hover:border-gold">
                    Copy to Clipboard
                </button>
            </div>

            <!-- OPTION B -->
            <div class="glass-panel p-8 rounded-xl border border-gray-700 hover:border-cyan-400 transition duration-500 group relative flex flex-col">
                <div class="absolute -top-3 left-6 bg-black px-3 border border-cyan-500/50 text-cyan-400 text-xs uppercase tracking-widest font-bold">
                    {{ result.style_b }}
                </div>
                
                <div class="mb-6 mt-4">
                    <span class="text-gray-500 text-[10px] uppercase tracking-widest font-bold">Subject Line</span>
                    <p class="text-white font-mono text-sm border-b border-gray-800 pb-2 mt-2 select-all">{{ result.subject_b }}</p>
                </div>
                
                <div class="bg-gray-900/50 p-4 rounded border border-gray-800 mb-8 flex-grow">
                    <pre id="email-b" class="text-gray-300 whitespace-pre-wrap font-sans text-sm leading-relaxed">{{ result.body_b }}</pre>
                </div>
                
                <button onclick="copyToClip('email-b')" class="w-full bg-gray-800 text-gray-400 text-xs uppercase tracking-widest py-3 rounded hover:bg-cyan-400 hover:text-black transition font-bold border border-gray-700 hover:border-cyan-400">
                    Copy to Clipboard
                </button>
            </div>

        </div>

        <!-- 5. FEEDBACK BUTTON -->
        <div class="text-center mt-16 mb-8">
            <p class="text-gray-500 text-xs uppercase tracking-widest mb-4">Did this email work?</p>
            <button id="likeBtn" onclick="sendLike()" class="group bg-gray-900 border border-gray-700 text-gray-400 px-8 py-4 rounded-full hover:border-green-500 hover:text-green-500 transition-all flex items-center gap-3 mx-auto shadow-lg hover:shadow-green-500/20">
                <span class="text-2xl group-hover:scale-125 transition-transform duration-300">üëç</span> 
                <span class="font-bold text-xs uppercase tracking-widest">Mark as High-Converting</span>
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- 6. SCRIPTS & STYLES -->
<script>
    // Auto-Scroll to results
    const resultSection = document.getElementById('result-section');
    if(resultSection) {
        setTimeout(() => {
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
    }

    // Copy Function
    function copyToClip(id) {
        const text = document.getElementById(id).innerText;
        navigator.clipboard.writeText(text).then(() => {
            alert("Protocol Copied to Clipboard.");
        });
    }

    // Like Function
    function sendLike() {
        const btn = document.getElementById('likeBtn');
        if(btn.classList.contains('border-green-500')) return; // Prevent double click

        fetch('/like', { method: 'POST' })
        .then(res => res.json())
        .then(() => {
            btn.classList.remove('border-gray-700', 'text-gray-400');
            btn.classList.add('border-green-500', 'text-green-500', 'bg-green-900/10');
            btn.innerHTML = '<span class="text-2xl">‚úÖ</span> <span class="font-bold text-xs uppercase tracking-widest">Recorded</span>';
        })
        .catch(err => console.error(err));
    }

    // Loading Animation Controller
    function startLoading() {
        const overlay = document.getElementById('loading-overlay');
        const text = document.getElementById('loading-text');
        overlay.classList.remove('hidden');
        overlay.classList.add('flex');

        const msgs = [
            "Connecting to Global News Feed...",
            "Scraping Industry Pain Points...",
            "Analyzing Competitive Landscape...",
            "Engineering R.E.P.L.Y. Hooks...",
            "Finalizing Strategy..."
        ];

        let i = 0;
        // Cycle messages every 1.5 seconds
        setInterval(() => {
            text.innerText = msgs[i % msgs.length];
            i++;
        }, 1500);
    }

    // Slider Visual Update
    function updateTemp(val) {
        let label = "Balanced";
        if (val <= 0.3) label = "Strict / Safe";
        if (val >= 0.8) label = "Creative / Bold";
        document.getElementById('temp-val').innerText = `${val} (${label})`;
    }
</script>

<style>
    /* WRITING ANIMATION */
    @keyframes writing {
        0% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(-15px, -5px) rotate(-15deg); }
        50% { transform: translate(0, 0) rotate(0deg); }
        75% { transform: translate(-10px, -8px) rotate(10deg); }
        100% { transform: translate(0, 0) rotate(0deg); }
    }
    .animate-writing {
        animation: writing 1.2s infinite ease-in-out;
    }
    
    /* FADE IN UP */
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up {
        animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }
</style>
{% endblock %}